<!DOCTYPE html>
<html lang="zh-cn" ng-app="feibao_claim_task">
<head>
    <meta charset="UTF-8">
    <title>废宝--领取任务</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../../css/bootstrap.css" />
    <link rel="stylesheet" href="../../css/index.css" />
    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="stylesheet" href="../../css/admin/style.css" />

</head>
<body>
<div class="jumbotron">
    <h1>废宝--领取任务</h1>
</div>

<!--<nav class="navbar navbar-default">-->
    <!--<div class="container">-->
        <!--<div class="navbar-header">-->
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#indexNavbar">-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
            <!--</button>-->
        <!--</div>-->
        <!--<div class="collapse navbar-collapse" id="indexNavbar">-->
            <!--<ul class="nav navbar-nav">-->
                <!--<li><a href="recycle_waste_manage.html"><span class="glyphicon glyphicon-refresh"></span> 废品回收</a></li>-->
                <!--<li><a href="mall_manage.html"><span class="glyphicon glyphicon-shopping-cart"></span> 网上商场</a></li>-->
            <!--</ul>-->
        <!--</div>-->
    <!--</div>-->
<!--</nav>-->


<div class="container" ng-controller="claim_task">
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation"  class="active"><a href="#bespeak_recycle_waste" aria-controls="bespeak_recycle_waste" role="tab" data-toggle="tab">预约回收</a></li>
        <li role="presentation"><a href="#cycle_recycle_waste" aria-controls="cycle_recycle_waste" role="tab" data-toggle="tab">今日周期回收</a></li>
        <li role="presentation"><a href="#mall_order" aria-controls="mall_order" role="tab" data-toggle="tab">未处理订单</a></li>
        <li role="presentation"><a href="#mall_distribution" aria-controls="mall_distribution" role="tab" data-toggle="tab">今日周期配送</a></li>
    </ul>

    <div class="tab-content">
        <!--预约回收-->
        <div role="tabpanel" class="tab-pane active" id="bespeak_recycle_waste">
            <table class="table text-center sort_btn_table">
                <tr>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_unclaim_bespeak_recycles_table]" ng-click="show_unclaim_bespeak_recycles()">今日上门</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_claim_unpay_bespeak_recycle_records_table]" ng-click="show_claim_unpay_bespeak_recycle_records(activeWorker.job_number)">已领取未付款</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_claim_pay_bespeak_recycle_records_table]" ng-click="show_claim_pay_bespeak_recycle_records(activeWorker.job_number)">已完成</button></td>
                </tr>
            </table>
            <br>
            <!--今日需上门回收的预约-->
            <table class="table table-bordered table-hover text-center" ng-show="is_show_unclaim_bespeak_recycles_table">
                <caption>今日需上门回收的预约</caption>
                <thead>
                    <td>日期</td>
                    <td>时间</td>
                    <td>废品类型</td>
                    <td>大致重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>预约用户</td>
                    <td>预约状态</td>
                    <td>回收者</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="bespeak_recycle in unclaim_bespeak_recycles">
                    <td>{{bespeak_recycle.date}}</td>
                    <td>{{bespeak_recycle.time}}</td>
                    <td>{{bespeak_recycle.sort_name}}</td>
                    <td>{{bespeak_recycle.weight}}</td>
                    <td>{{bespeak_recycle.contact_name}}</td>
                    <td>{{bespeak_recycle.contact_phone}}</td>
                    <td>{{bespeak_recycle.contact_address}}</td>
                    <td>{{bespeak_recycle.user_name}}</td>
                    <td>
                        <span ng-show="bespeak_recycle.state ==0">未回收</span>
                        <span ng-show="bespeak_recycle.state !=0">已回收或取消</span>
                    </td>
                    <td><input class="form-control form-inline" ng-model="bespeak_recycle.job_number" placeholder="输入工作号领取任务"></td>
                    <td><button class="btn btn-default" ng-disabled="!bespeak_recycle.job_number" ng-click="claim_bespeak_recycle(bespeak_recycle._id,$index)">领取</button></td>
                </tr>
            </table>

            <!--已领取未付款预约回收记录-->
            <table class="table table-bordered table-striped table-hover text-center" ng-show="is_show_claim_unpay_bespeak_recycle_records_table">
                <caption>未付款给用户</caption>
                <thead>
                    <td>日期</td>
                    <td>时间</td>
                    <td>废品类型</td>
                    <td>重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>预约用户</td>
                    <td>工号</td>
                    <td>是否付款</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="bespeak_recycle_record in claim_unpay_bespeak_recycle_records">
                    <td>{{bespeak_recycle_record.date}}</td>
                    <td>{{bespeak_recycle_record.time}}</td>
                    <td>{{bespeak_recycle_record.sort_name}}</td>
                    <td>{{bespeak_recycle_record.weight}} kg</td>
                    <td>{{bespeak_recycle_record.contact_name}}</td>
                    <td>{{bespeak_recycle_record.contact_phone}}</td>
                    <td>{{bespeak_recycle_record.contact_address}}</td>
                    <td>{{bespeak_recycle_record.user_name}}</td>
                    <td>{{bespeak_recycle_record.job_number}}</td>
                    <td>
                        <span ng-show="bespeak_recycle_record.is_pay ==0">未付款</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-default" ng-click="pay_claim_bespeak_recycle_record(bespeak_recycle_record._id)">付款</button>
                    </td>
                </tr>
            </table>

            <!--已完成预约回收记录-->
            <table class="table table-bordered table-striped table-hover text-center" ng-show="is_show_claim_pay_bespeak_recycle_records_table">
                <caption>已完成预约回收</caption>
                <thead>
                    <td>日期</td>
                    <td>时间</td>
                    <td>废品类型</td>
                    <td>重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>预约用户</td>
                    <td>工号</td>
                    <td>是否付款</td>
                    <td>付款方式</td>
                    <td>付款金额</td>
                </thead>
                <tr ng-repeat="bespeak_recycle_record in claim_pay_bespeak_recycle_records | orderBy:'-date'">
                    <td>{{bespeak_recycle_record.date}}</td>
                    <td>{{bespeak_recycle_record.time}}</td>
                    <td>{{bespeak_recycle_record.sort_name}}</td>
                    <td>{{bespeak_recycle_record.weight}} kg</td>
                    <td>{{bespeak_recycle_record.contact_name}}</td>
                    <td>{{bespeak_recycle_record.contact_phone}}</td>
                    <td>{{bespeak_recycle_record.contact_address}}</td>
                    <td>{{bespeak_recycle_record.user_name}}</td>
                    <td>{{bespeak_recycle_record.job_number}}</td>
                    <td>
                        <span ng-show="bespeak_recycle_record.is_pay ==1">已付款</span>
                    </td>
                    <td>
                        <span ng-show="bespeak_recycle_record.pay_mode ==0">电子货币付款</span>
                        <span ng-show="bespeak_recycle_record.pay_mode ==1">现金付款</span>
                    </td>
                    <td>
                        {{bespeak_recycle_record.pay_number}}
                    </td>
                </tr>
            </table>
        </div>

        <!--周期回收-->
        <div role="tabpanel" class="tab-pane text-center" id="cycle_recycle_waste">
            <table class="table text-center sort_btn_table">
                <tr>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_today_unclaim_cycle_recycles_table]" ng-click="show_today_unclaim_cycle_recycles()">今日上门</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_all_unclaim_cycle_recycles_table]" ng-click="show_all_unclaim_cycle_recycles()">有效周期回收</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_claim_unpay_cycle_recycle_records_table]" ng-click="show_claim_unpay_cycle_recycle_records(activeWorker.job_number)">已领取未付款</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_claim_pay_cycle_recycle_records_table]" ng-click="show_claim_pay_cycle_recycle_records(activeWorker.job_number)">已完成</button></td>
                </tr>
            </table>
            <br>
            <!--今日周期回收-->
            <table class="table table-bordered table-hover text-center" ng-show="is_show_today_unclaim_cycle_recycles_table">
                <caption>今日需上门的周期回收</caption>
                <thead>
                    <td>开始日期</td>
                    <td>时间</td>
                    <td>间隔</td>
                    <td>上回日期</td>
                    <td>废品类型</td>
                    <td>大致重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>用户</td>
                    <td>回收者</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="cycle_recycle in today_unclaim_cycle_recycles">
                    <td>{{cycle_recycle.begin_date}}</td>
                    <td>{{cycle_recycle.time}}</td>
                    <td>{{cycle_recycle.interval | translate_number_interval}}</td>
                    <td>{{cycle_recycle.last_cycle_date}}</td>
                    <td>{{cycle_recycle.sort_name}}</td>
                    <td>{{cycle_recycle.weight}} kg</td>
                    <td>{{cycle_recycle.contact_name}}</td>
                    <td>{{cycle_recycle.contact_phone}}</td>
                    <td>{{cycle_recycle.contact_address}}</td>
                    <td>{{cycle_recycle.user_name}}</td>
                    <!--<td>-->
                        <!--<span ng-show="cycle_recycle.state ==0">未回收</span>-->
                        <!--<span ng-show="cycle_recycle.state !=0">已回收或取消</span>-->
                    <!--</td>-->
                    <td><input class="form-control form-inline" ng-model="cycle_recycle.job_number" placeholder="输入工作号领取任务"></td>
                    <td><button class="btn btn-default" ng-disabled="!cycle_recycle.job_number" ng-click="claim_cycle_recycle(cycle_recycle._id,$index)">领取</button></td>
                </tr>
            </table>

            <!--所有有效周期回收-->
            <table class="table table-bordered table-hover text-center" ng-show="is_show_all_unclaim_cycle_recycles_table">
                <caption>所有有效周期回收</caption>
                <thead>
                    <td>开始日期</td>
                    <td>时间</td>
                    <td>间隔</td>
                    <td>上回日期</td>
                    <td>废品类型</td>
                    <td>大致重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>用户</td>
                    <td>状态</td>
                </thead>
                <tr ng-repeat="cycle_recycle in all_unclaim_cycle_recycles | orderBy:'begin_date'">
                    <td>{{cycle_recycle.begin_date}}</td>
                    <td>{{cycle_recycle.time}}</td>
                    <td>{{cycle_recycle.interval | translate_number_interval}}</td>
                    <td>{{cycle_recycle.last_cycle_date}}</td>
                    <td>{{cycle_recycle.sort_name}}</td>
                    <td>{{cycle_recycle.weight}} kg</td>
                    <td>{{cycle_recycle.contact_name}}</td>
                    <td>{{cycle_recycle.contact_phone}}</td>
                    <td>{{cycle_recycle.contact_address}}</td>
                    <td>{{cycle_recycle.user_name}}</td>
                    <td>
                        <span ng-show="cycle_recycle.state ==0">有效</span>
                        <span ng-show="cycle_recycle.state !=0">已回收或取消</span>
                    </td>
                </tr>
            </table>

            <!--已领取未付款的周期回收记录-->
            <table class="table table-bordered table-hover text-center" ng-show="is_show_claim_unpay_cycle_recycle_records_table">
                <caption>已领取未付款的周期回收记录</caption>
                <thead>
                    <td>开始日期</td>
                    <td>时间</td>
                    <td>间隔</td>
                    <td>回收日期</td>
                    <td>废品类型</td>
                    <td>大致重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>用户</td>
                    <td>工号</td>
                    <td>是否付款</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="cycle_recycle_record in claim_unpay_cycle_recycle_records">
                    <td>{{cycle_recycle_record.begin_date}}</td>
                    <td>{{cycle_recycle_record.time}}</td>
                    <td>{{cycle_recycle_record.interval | translate_number_interval}}</td>
                    <td>{{cycle_recycle_record.last_cycle_date}}</td>
                    <td>{{cycle_recycle_record.sort_name}}</td>
                    <td>{{cycle_recycle_record.weight}} kg</td>
                    <td>{{cycle_recycle_record.contact_name}}</td>
                    <td>{{cycle_recycle_record.contact_phone}}</td>
                    <td>{{cycle_recycle_record.contact_address}}</td>
                    <td>{{cycle_recycle_record.user_name}}</td>
                    <td>{{cycle_recycle_record.job_number}}</td>
                    <td>
                        <span ng-show="cycle_recycle_record.is_pay ==0">未付款</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-default" ng-click="pay_claim_cycle_recycle_record(cycle_recycle_record._id)">付款</button>
                    </td>
                </tr>
            </table>

            <!--已完成周期回收记录-->
            <table class="table table-bordered table-hover table-striped text-center" ng-show="is_show_claim_pay_cycle_recycle_records_table">
                <caption>已完成周期回收记录</caption>
                <thead>
                    <td>开始日期</td>
                    <td>时间</td>
                    <td>间隔</td>
                    <td>回收日期</td>
                    <td>废品类型</td>
                    <td>大致重量</td>
                    <td>联系人</td>
                    <td>手机</td>
                    <td>详细地址</td>
                    <td>用户</td>
                    <td>工号</td>
                    <td>是否付款</td>
                    <td>付款方式</td>
                    <td>付款金额</td>
                </thead>
                <tr ng-repeat="cycle_recycle_record in claim_pay_cycle_recycle_records">
                    <td>{{cycle_recycle_record.begin_date}}</td>
                    <td>{{cycle_recycle_record.time}}</td>
                    <td>{{cycle_recycle_record.interval | translate_number_interval}}</td>
                    <td>{{cycle_recycle_record.last_cycle_date}}</td>
                    <td>{{cycle_recycle_record.sort_name}}</td>
                    <td>{{cycle_recycle_record.weight}} kg</td>
                    <td>{{cycle_recycle_record.contact_name}}</td>
                    <td>{{cycle_recycle_record.contact_phone}}</td>
                    <td>{{cycle_recycle_record.contact_address}}</td>
                    <td>{{cycle_recycle_record.user_name}}</td>
                    <td>{{cycle_recycle_record.job_number}}</td>
                    <td>
                        <span ng-show="cycle_recycle_record.is_pay ==1">已付款</span>
                    </td>
                    <td>
                        <span ng-show="cycle_recycle_record.pay_mode ==0">电子货币付款</span>
                        <span ng-show="cycle_recycle_record.pay_mode ==1">现金付款</span>
                    </td>
                    <td>
                        {{cycle_recycle_record.pay_number}}
                    </td>
                </tr>
            </table>
        </div>

        <!--订单-->
        <div role="tabpanel" class="tab-pane text-center" id="mall_order">
            <table class="table text-center sort_btn_table">
                <tr>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_undeliver_orders_table]" ng-click="show_undeliver_orders()">未发货</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_deliver_order_records_table]" ng-click="show_deliver_order_records(activeWorker.job_number)">已完成</button></td>
                </tr>
            </table>
            <!--未发货订单   $scope.order.state =0;//0未付款,1付款,2取消,3已发货-->
            <table class="table table-bordered table-hover" is_show_today_undeliver_cycle_distributions_table>
                <caption>未发货订单</caption>
                <thead>
                    <td>日期</td>
                    <td>商品</td>
                    <td>总数量</td>
                    <td>总价格</td>
                    <td>收货人</td>
                    <td>手机</td>
                    <td>地址</td>
                    <td>下单用户</td>
                    <!--<td>订单状态</td>-->
                    <!--<td>付款方式</td>-->
                    <td>送货员</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="order in undeliver_orders">
                    <td>{{order.date}}</td>
                    <td>
                        <table>
                            <tr>
                                <td>名称</td>
                                <td>数量</td>
                            </tr>
                            <tr ng-repeat="ware in order.wares">
                                <td>{{ware.ware_name}}</td>
                                <td>【{{ware.quantity}}】</td>
                            </tr>
                        </table>
                    </td>
                    <td>{{order.amount}}</td>
                    <td>{{order.total_price}}</td>
                    <td>{{order.contact_name}}</td>
                    <td>{{order.contact_phone}}</td>
                    <td>{{order.contact_address}}</td>
                    <td>{{order.user_name}}</td>
                    <!--<td>-->
                        <!--<span ng-show="order.state ==1">已付款未发货</span>-->
                    <!--</td>-->
                    <!--<td>-->
                        <!--<span ng-show="order.pay_mode ==0">平台电子货币</span>-->
                    <!--</td>-->
                    <td>
                        <input class="form-control form-inline" ng-model="order.job_number" placeholder="输入工作号领取发货任务">
                    </td>
                    <td><button class="btn btn-default" ng-disabled="!order.job_number" ng-click="order_deliver(order._id,$index)">发货</button></td>
                </tr>

            </table>

            <!--已完成订单记录   $scope.order.state =0;//0未付款,1付款,2取消,3已发货-->
            <table class="table table-bordered table-hover" ng-show="is_show_deliver_order_records_table">
                <caption>未发货订单</caption>
                <thead>
                    <td>下单日期</td>
                    <td>商品</td>
                    <td>总数量</td>
                    <td>总价格</td>
                    <td>收货人</td>
                    <td>手机</td>
                    <td>地址</td>
                    <td>下单用户</td>
                    <td>订单状态</td>
                    <td>付款方式</td>
                    <td>发货日期</td>
                    <td>送货员</td>
                </thead>
                <tr ng-repeat="order_record in deliver_order_records">
                    <td>{{order_record.date}}</td>
                    <td>
                        <div ng-repeat="ware in order_record.wares">
                            <span>{{ware.ware_name}}</span>
                            <span>{{ware.quantity}}</span>
                        </div>
                    </td>
                    <td>{{order_record.amount}}</td>
                    <td>{{order_record.total_price}}</td>
                    <td>{{order_record.contact_name}}</td>
                    <td>{{order_record.contact_phone}}</td>
                    <td>{{order_record.contact_address}}</td>
                    <td>{{order_record.user_name}}</td>
                    <td>
                        <span ng-show="order_record.state ==4">已发货</span>
                    </td>
                    <td>
                        <span ng-show="order_record.pay_mode ==0">平台电子货币</span>
                    </td>
                    <td>{{order_record.deliver_date}}</td>
                    <td>{{order_record.job_number}}</td>
                </tr>

            </table>
        </div>

        <!--周期配送-->
        <div role="tabpanel" class="tab-pane text-center" id="mall_distribution">
            <table class="table text-center sort_btn_table">
                <tr>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_today_undeliver_cycle_distributions_table]" ng-click="show_today_undeliver_cycle_distributions()">今日配送</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_all_undeliver_cycle_distributions_table]" ng-click="show_all_undeliver_cycle_distributions()">有效周期配送</button></td>
                    <td><button class="btn btn-default" ng-class="{true: 'btn-success', false: 'btn-default'}[is_show_deliver_cycle_distribution_records_table]" ng-click="show_deliver_cycle_distribution_records(activeWorker.job_number)">已完成</button></td>
                </tr>
            </table>
            <br>
            <!--今日未处理周期配送-->
            <table class="table table-bordered table-hover" ng-show="is_show_today_undeliver_cycle_distributions_table">
                <caption>今日周期配送</caption>
                <thead>
                    <td>开始日期</td>
                    <td>间隔</td>
                    <td>上回日期</td>
                    <td>商品</td>
                    <td>总数量</td>
                    <td>总价格</td>
                    <td>收货人</td>
                    <td>手机</td>
                    <td>地址</td>
                    <td>下单用户</td>
                    <td>状态</td>
                    <td>付款方式</td>
                    <td>配送人员</td>
                    <td>操作</td>
                </thead>
                <tr ng-repeat="cycle_distribution in today_undeliver_cycle_distributions">
                    <td>{{cycle_distribution.begin_date}}</td>
                    <td>{{cycle_distribution.interval | translate_number_interval}}</td>
                    <td>{{cycle_distribution.last_distribution_date}}</td>
                    <td>
                        <div ng-repeat="ware in cycle_distribution.wares">
                            {{ware.name}} 【{{ware.quantity}}】
                        </div>
                    </td>
                    <td>{{cycle_distribution.amount}}</td>
                    <td>{{cycle_distribution.total_price}}元</td>
                    <td>{{cycle_distribution.contact_name}}</td>
                    <td>{{cycle_distribution.contact_phone}}</td>
                    <td>{{cycle_distribution.contact_address}}</td>
                    <td>{{cycle_distribution.user_name}}</td>
                    <td><span ng-show="cycle_distribution.state ==0">未付款</span></td>
                    <td><span ng-show="cycle_distribution.pay_mode ==1">货到付款</span></td>
                    <td><input class="form-control form-inline" ng-model="cycle_distribution.job_number" placeholder="输入工作号领取任务"></td>
                    <td><button class="btn btn-default" ng-disabled="!cycle_distribution.job_number" ng-click="deliver_cycle_distribution(cycle_distribution._id,$index)">配送</button></td>
                </tr>

            </table>

            <!--所有有效周期配送-->
            <table class="table table-bordered table-hover" ng-show="is_show_all_undeliver_cycle_distributions_table">
                <caption>有效周期配送</caption>
                <thead>
                    <td>开始日期</td>
                    <td>间隔</td>
                    <td>上回日期</td>
                    <td>商品</td>
                    <td>总数量</td>
                    <td>总价格</td>
                    <td>收货人</td>
                    <td>手机</td>
                    <td>地址</td>
                    <td>下单用户</td>
                    <td>状态</td>
                    <td>付款方式</td>
                </thead>
                <tr ng-repeat="cycle_distribution in all_undeliver_cycle_distributions">
                    <td>{{cycle_distribution.begin_date}}</td>
                    <td>{{cycle_distribution.interval | translate_number_interval}}</td>
                    <td>{{cycle_distribution.last_distribution_date}}</td>
                    <td>
                        <div ng-repeat="ware in cycle_distribution.wares">
                            {{ware.name}} 【{{ware.quantity}}】
                        </div>
                    </td>
                    <td>{{cycle_distribution.amount}}</td>
                    <td>{{cycle_distribution.total_price}}元</td>
                    <td>{{cycle_distribution.contact_name}}</td>
                    <td>{{cycle_distribution.contact_phone}}</td>
                    <td>{{cycle_distribution.contact_address}}</td>
                    <td>{{cycle_distribution.user_name}}</td>
                    <td>
                        <span ng-show="cycle_distribution.state ==0">未配送</span>
                        <span ng-show="cycle_distribution.state ==1">已配送</span>
                    </td>
                    <td><span ng-show="cycle_distribution.pay_mode ==1">货到付款</span></td>
                </tr>
            </table>

            <!--所有已完成周期配送-->
            <table class="table table-bordered table-hover text-center" ng-show="is_show_deliver_cycle_distribution_records_table">
                <caption>已完成周期配送</caption>
                <thead>
                    <td>开始日期</td>
                    <td>间隔</td>
                    <td>上配日期</td>
                    <td>商品</td>
                    <td>总数量</td>
                    <td>总价格</td>
                    <td>收货人</td>
                    <td>手机</td>
                    <td>地址</td>
                    <td>下单用户</td>
                    <td>付款方式</td>
                    <td>取得付款</td>
                    <td>工号</td>
                    <td>状态</td>
                </thead>
                <tr ng-repeat="cycle_distribution_record in deliver_cycle_distribution_records">
                    <td>{{cycle_distribution_record.begin_date}}</td>
                    <td>{{cycle_distribution_record.interval | translate_number_interval}}</td>
                    <td>{{cycle_distribution_record.last_distribution_date}}</td>
                    <td>
                        <div ng-repeat="ware in cycle_distribution_record.wares">
                        {{ware.name}} 【{{ware.quantity}}】
                        </div>
                    </td>
                    <td>{{cycle_distribution_record.amount}}</td>
                    <td>{{cycle_distribution_record.total_price}}</td>
                    <td>{{cycle_distribution_record.contact_name}}</td>
                    <td>{{cycle_distribution_record.contact_phone}}</td>
                    <td>{{cycle_distribution_record.contact_address}}</td>
                    <td>{{cycle_distribution_record.user_name}}</td>
                    <td>
                        <span ng-show="cycle_distribution_record.pay_mode ==0">电子货币付款</span>
                        <span ng-show="cycle_distribution_record.pay_mode ==1">货到付款</span>
                    </td>
                    <td>
                        <span ng-show="cycle_distribution_record.is_get_pay ==1">已取得付款</span>
                    </td>
                    <td>{{cycle_distribution_record.job_number}}</td>
                    <td>
                        <span ng-show="cycle_distribution_record.state ==4">已完成</span>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!--预约回收付款模态框-->
    <div class="modal fade" id="pay_bespeak_recycle_record_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">预约回收付款</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">预约日期:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="date" disabled="disabled"  ng-model="will_pay_bespeak_recycle_record.date">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">时间:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="date" disabled="disabled"  ng-model="will_pay_bespeak_recycle_record.time">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">废品类型(可添加完善):</label>
                            <div class="col-sm-6 col-md-6">
                                <input class="form-control form-inline" ng-model="will_pay_bespeak_recycle_record.sort_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">重量kg（实际重量）:</label>
                            <div class="col-sm-6 col-md-6">
                                <input class="form-control form-inline" ng-model="will_pay_bespeak_recycle_record.weight">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">联系人:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" placeholder="收货人姓名" disabled="disabled" name="contact_name" ng-model="will_pay_bespeak_recycle_record.contact_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-4 col-md-4 control-label">手机（联系方式）:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_number" disabled="disabled" ng-model="will_pay_bespeak_recycle_record.contact_phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">详细地址:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_bespeak_recycle_record.contact_address">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">预约用户:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_bespeak_recycle_record.user_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">工号:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_bespeak_recycle_record.job_number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">付款方式:</label>
                            <div class="col-sm-6 col-md-6">
                                <select name="pay_mode" ng-model="will_pay_bespeak_recycle_record.pay_mode">
                                    <option value="0">平台电子货币</option>
                                    <option value="1">现金支付</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">付款金额:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" ng-model="will_pay_bespeak_recycle_record.pay_number"> 元
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" ng-click="confirm_pay_claim_bespeak_recycle(will_pay_bespeak_recycle_record._id)">确认付款</button>
                </div>
            </div>
        </div>
    </div>

    <!--周期回收付款模态框-->
    <div class="modal fade" id="pay_cycle_recycle_record_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">周期回收付款</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">开始日期:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="date" disabled="disabled"  ng-model="will_pay_cycle_recycle_record.begin_date">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">时间:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="time" disabled="disabled"  ng-model="will_pay_cycle_recycle_record.time">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">间隔:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="interval" disabled="disabled"  ng-model="will_pay_cycle_recycle_record.interval">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">废品类型(可添加完善):</label>
                            <div class="col-sm-6 col-md-6">
                                <input class="form-control form-inline" ng-model="will_pay_cycle_recycle_record.sort_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">重量kg（实际重量）:</label>
                            <div class="col-sm-6 col-md-6">
                                <input class="form-control form-inline" ng-model="will_pay_cycle_recycle_record.weight">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">联系人:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" placeholder="收货人姓名" disabled="disabled" name="contact_name" ng-model="will_pay_cycle_recycle_record.contact_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-4 col-md-4 control-label">手机（联系方式）:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_number" disabled="disabled" ng-model="will_pay_cycle_recycle_record.contact_phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">详细地址:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_cycle_recycle_record.contact_address">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">用户:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_cycle_recycle_record.user_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">工号:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" disabled="disabled" ng-model="will_pay_cycle_recycle_record.job_number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">付款方式:</label>
                            <div class="col-sm-6 col-md-6">
                                <select name="pay_mode" ng-model="will_pay_cycle_recycle_record.pay_mode">
                                    <option value="0">平台电子货币</option>
                                    <option value="1">现金支付</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 col-md-4 control-label">付款金额:</label>
                            <div class="col-sm-6 col-md-6">
                                <input type="text" class="form-control" name="contact_address" ng-model="will_pay_cycle_recycle_record.pay_number">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" ng-click="confirm_pay_claim_cycle_recycle_record(will_pay_cycle_recycle_record._id)">确认付款</button>
                </div>
            </div>
        </div>
    </div>
</div>



</body>
<script src="../../js/jquery-1.11.3.js"></script>
<script src="../../js/bootstrap.js"></script>
<script src="../../js/angular.js"></script>
<script src="../../js/angular-route.js"></script>
<script type="text/javascript">
    var app =angular.module('feibao_claim_task',['ngRoute']);
    app.controller('claim_task',function($rootScope,$scope,$http){
//        $scope.unclaim_bespeak_recycles =[];//未处理预约回收
        $scope.bespeak_recycle_record ={};//预约回收处理记录
        $scope.cycle_recycle_record ={};//周期回收处理记录
        $scope.order_record ={};//订单记录
        $scope.cycle_distribution_record ={};//周期配送记录
        $scope.will_pay_bespeak_recycle_record ={};//将要付款预约回收记录
        $scope.will_pay_cycle_recycle_record ={};//将要付款周期回收记录
        $scope.all_unclaim_cycle_recycles = [];//所有未处理周期回收
        $scope.today_unclaim_cycle_recycles = [];//今日未处理周期回收
        $scope.all_undeliver_cycle_distributions = [];//所有未处理周期配送
        $scope.today_undeliver_cycle_distributions = [];//今日未处理周期配送
        //是否有新的预约回收记录
        $scope.has_new_claim_pay_bespeak_recycle_record = false;//是否有新完成预约回收
        $scope.has_new_claim_unpay_bespeak_recycle_record = false;//是否有领取的预约回收记录
        //是否有新的周期回收记录
        $scope.has_new_claim_pay_cycle_recycle_record = false;//是否有新完成周期回收
        $scope.has_new_claim_unpay_cycle_recycle_record = false;//是否有领取的周期回收记录
        //是否有新的订单记录
        $scope.has_new_deliver_order_record = false;//是否有新发货订单记录
        //是否有新的周期配送记录
        $scope.has_new_deliver_cycle_distribution_record = false;//是否有新周期配送记录
        //预约回收table之间显示隐藏
        $scope.is_show_unclaim_bespeak_recycles_table =true;
        $scope.is_show_claim_unpay_bespeak_recycle_records_table =false;
        $scope.is_show_claim_pay_bespeak_recycle_records_table =false;
        //周期回收table之间显示隐藏
        $scope.is_show_today_unclaim_cycle_recycles_table =true;
        $scope.is_show_all_unclaim_cycle_recycles_table =false;
        $scope.is_show_claim_unpay_cycle_recycle_records_table =false;
        $scope.is_show_claim_pay_cycle_recycle_records_table =false;
        //订单table之间显示隐藏
        $scope.is_show_undeliver_orders_table =true;
        $scope.is_show_deliver_order_records_table =false;
        //周期配送table之间显示隐藏
        $scope.is_show_today_undeliver_cycle_distributions_table =true;
        $scope.is_show_all_undeliver_cycle_distributions_table =false;
        $scope.is_show_deliver_cycle_distribution_records_table =false;
        //获取今天日期
        var today =new Date();
        today =today.getFullYear() + '-' + (today.getMonth()+1) + '-' + today.getDate();

        //获取今日未回收预约回收
        $http({
            url:'/bespeak_recycles/find_unclaim',
            method:'GET'
        }).success(function(unclaim_bespeak_recycles){
            $scope.unclaim_bespeak_recycles =unclaim_bespeak_recycles;
        });
        $scope.show_unclaim_bespeak_recycles =function(){
            $scope.is_show_unclaim_bespeak_recycles_table =true;
            $scope.is_show_claim_unpay_bespeak_recycle_records_table =false;
            $scope.is_show_claim_pay_bespeak_recycle_records_table =false;
            if($scope.unclaim_bespeak_recycles ==undefined){
                //获取今天所有未处理的预约回收
                $http({
                    url:'/bespeak_recycles/find_unclaim',
                    method:'GET'
                }).success(function(unclaim_bespeak_recycles){
                    $scope.unclaim_bespeak_recycles =unclaim_bespeak_recycles;
                });
            }
        };

        //获取所有未处理的周期回收state==0
        $http({
            url: '/cycle_recycles/find_all_unclaim',
            method: 'GET'
        }).success(function (all_unclaim_cycle_recycles) {
            $scope.all_unclaim_cycle_recycles = all_unclaim_cycle_recycles;
            //根据间隔计算今日需要上门的周期回收
            angular.forEach($scope.all_unclaim_cycle_recycles,function(unclaim_cycle_recycle,key){
                var is_today =$scope.getNextDate(unclaim_cycle_recycle.last_cycle_date,unclaim_cycle_recycle.interval);
                if(is_today ==today){
                    $scope.today_unclaim_cycle_recycles.push(unclaim_cycle_recycle);
                }
            });
        });
        $scope.show_all_unclaim_cycle_recycles =function(){
            $scope.is_show_today_unclaim_cycle_recycles_table =false;
            $scope.is_show_all_unclaim_cycle_recycles_table =true;
            $scope.is_show_claim_unpay_cycle_recycle_records_table =false;
            $scope.is_show_claim_pay_cycle_recycle_records_table =false;
            $http({
                url: '/cycle_recycles/find_all_unclaim',
                method: 'GET'
            }).success(function (all_unclaim_cycle_recycles) {
                $scope.all_unclaim_cycle_recycles = all_unclaim_cycle_recycles;
            });
        };

        //获取今日需上门周期回收
        $scope.show_today_unclaim_cycle_recycles =function(){
            //清空记录
            $scope.today_unclaim_cycle_recycles =[];
            $scope.is_show_today_unclaim_cycle_recycles_table =true;
            $scope.is_show_all_unclaim_cycle_recycles_table =false;
            $scope.is_show_claim_unpay_cycle_recycle_records_table =false;
            $scope.is_show_claim_pay_cycle_recycle_records_table =false;
            angular.forEach($scope.all_unclaim_cycle_recycles,function(unclaim_cycle_recycle,key){
                var is_today =$scope.getNextDate(unclaim_cycle_recycle.last_cycle_date,unclaim_cycle_recycle.interval);
                if(is_today ==today){
                    $scope.today_unclaim_cycle_recycles.push(unclaim_cycle_recycle);
                }
//                alert(JSON.stringify($scope.today_unclaim_cycle_recycles));
            });
        };


        //获取未发货的订单
        $http({
            url:'/orders/find_undeliver',
            method:'GET'
        }).success(function(undeliver_orders){
            $scope.undeliver_orders =undeliver_orders;
        });
        $scope.show_undeliver_orders =function(){
            $scope.is_show_undeliver_orders_table =true;
            $scope.is_show_deliver_order_records_table =false;
            if($scope.undeliver_orders ==undefined){
                //获取今天所有未处理的预约回收
                $http({
                    url:'/orders/find_undeliver',
                    method:'GET'
                }).success(function(undeliver_orders){
                    $scope.undeliver_orders =undeliver_orders;
                });
            }
        };

        //获取所有未处理的周期配送state==0
        $http({
            url: '/cycle_distributions/find_all_undeliver',
            method: 'GET'
        }).success(function (all_undeliver_cycle_distributions) {
            $scope.all_undeliver_cycle_distributions = all_undeliver_cycle_distributions;
            //根据间隔计算今日需要上门的周期配送
            angular.forEach($scope.all_undeliver_cycle_distributions,function(undeliver_cycle_distribution,key){
                var is_today =$scope.getNextDate(undeliver_cycle_distribution.last_distribution_date,undeliver_cycle_distribution.interval);
                if(is_today ==today){
                    $scope.today_undeliver_cycle_distributions.push(undeliver_cycle_distribution);
                }
            });
        });
        $scope.show_all_undeliver_cycle_distributions =function(){
            $scope.is_show_today_undeliver_cycle_distributions_table =false;
            $scope.is_show_all_undeliver_cycle_distributions_table =true;
            $scope.is_show_deliver_cycle_distribution_records_table =false;
            if($scope.all_undeliver_cycle_distributions.length <1){
                $http({
                    url: '/cycle_distributions/find_all_undeliver',
                    method: 'GET'
                }).success(function (all_undeliver_cycle_distributions) {
                    $scope.all_undeliver_cycle_distributions = all_undeliver_cycle_distributions;
                });
            }

        };

        //获取今日需配送周期配送
        $scope.show_today_undeliver_cycle_distributions =function(){
            //清空记录
            $scope.today_undeliver_cycle_distributions =[];
            $scope.is_show_today_undeliver_cycle_distributions_table =true;
            $scope.is_show_all_undeliver_cycle_distributions_table =false;
            $scope.is_show_deliver_cycle_distribution_records_table =false;
            if($scope.today_undeliver_cycle_distributions.length <1){
                angular.forEach($scope.all_undeliver_cycle_distributions,function(undeliver_cycle_distribution,key){
                    var is_today =$scope.getNextDate(undeliver_cycle_distribution.last_distribution_date,undeliver_cycle_distribution.interval);
                    if(is_today ==today){
                        $scope.today_undeliver_cycle_distributions.push(undeliver_cycle_distribution);
                    }
                });
            }

        };

        //领取预约回收
        $scope.claim_bespeak_recycle =function(id,index){
            $scope.bespeak_recycle_record =$scope.unclaim_bespeak_recycles[index];
            $scope.bespeak_recycle_record.worker_id =$rootScope.activeWorker._id;
            $scope.bespeak_recycle_record.state =1;//0:表示未回收,1表示领取,2表示取消,3表示日期过了失效,4已完成
            $scope.bespeak_recycle_record.pay_mode =0;//0表示平台电子货币，1表示现金付款
            $scope.bespeak_recycle_record.pay_number =0;//付款金额
            $scope.bespeak_recycle_record.is_pay =0;//是否付款:0未付款给用户，1付款给用户。
//            alert(JSON.stringify($scope.bespeak_recycle_record));
            //插入领取预约回收记录
            $http({
                url:'/bespeak_recycle_records/add',
                method:"POST",
                data:$scope.bespeak_recycle_record
            }).success(function (bespeak_recycle_record) {
                if(bespeak_recycle_record){
                    $scope.has_new_claim_unpay_bespeak_recycle_record =true;
                    //将对应的预约回收的状态改为1已领取
                    $http({
                        url:'/bespeak_recycles/claim',
                        method:'POST',
                        data:{
                            id:id
                        }
                    }).success(function(unclaim_bespeak_recycles){
                        //领取成功之后，1更新未领取数据，2插入领取预约回收记录
                        $scope.unclaim_bespeak_recycles =unclaim_bespeak_recycles;
                    }).error(function(){
                        alert('领取失败');
                    });
                    alert('领取成功');
                }
            }).error(function(){
                alert('生成领取记录失败');
            });
        };

        //领取周期回收应该改为先领取记录成功再更新周期回收
        $scope.claim_cycle_recycle =function(id,index){
            $scope.cycle_recycle_record =$scope.today_unclaim_cycle_recycles[index];
            $scope.cycle_recycle_record.last_cycle_date =today;
            $scope.cycle_recycle_record.worker_id =$rootScope.activeWorker._id;
            $scope.cycle_recycle_record.state =1;//0:表示未回收,1表示领取,2表示取消,3表示日期过了失效,4已完成
            $scope.cycle_recycle_record.pay_mode =0;//0表示平台电子货币，1表示现金付款
            $scope.cycle_recycle_record.pay_number =0;//付款金额
            $scope.cycle_recycle_record.is_pay =0;//是否付款:0未付款给用户，1付款给用户。
//            alert(JSON.stringify($scope.bespeak_recycle_record));
            //插入领取预约回收记录
            $http({
                url:'/cycle_recycle_records/add',
                method:"POST",
                data:$scope.cycle_recycle_record
            }).success(function (cycle_recycle_record) {
                if(cycle_recycle_record){
                    //新领取周期回收记录
                    $scope.has_new_claim_unpay_cycle_recycle_record =true;
                    //将对应的周期回收的状态改为1已领取
                    $http({
                        url:'/cycle_recycles/claim',
                        method:'POST',
                        data:{
                            id:id,
                            last_cycle_date:today
                        }
                    }).success(function(all_unclaim_cycle_recycles){
                        //清空原有数据
                        $scope.today_unclaim_cycle_recycles =[];
                        //领取成功之后，1更新未领取数据，2插入领取预约回收记录
                        $scope.all_unclaim_cycle_recycles = all_unclaim_cycle_recycles;
                        //根据间隔计算今日需要上门的周期回收
                        angular.forEach($scope.all_unclaim_cycle_recycles,function(unclaim_cycle_recycle,key){
                            var is_today =$scope.getNextDate(unclaim_cycle_recycle.last_cycle_date,unclaim_cycle_recycle.interval);
                            if(is_today ==today){
                                $scope.today_unclaim_cycle_recycles.push(unclaim_cycle_recycle);
                            }
                        });
                    }).error(function(){
                        alert('领取失败');
                    });
                    alert('领取成功');
                }
            }).error(function(){
                alert('生成领取记录失败');
            });

        };

        //领取订单发货
        $scope.order_deliver =function(id,index){
            $scope.order_record =$scope.undeliver_orders[index];
            $scope.order_record.worker_id =$rootScope.activeWorker._id;
            $scope.order_record.state =4;//0:表示未回收,1表示领取,2表示取消,3表示日期过了失效,4已完成
            $scope.order_record.deliver_date =today;//发货日期
            //插入领取订单记录
            $http({
                url:'/order_records/add',
                method:"POST",
                data:$scope.order_record
            }).success(function (order_record) {
                if(order_record){
                    $scope.has_new_deliver_order_record =true;
                    //将对应的预约回收的状态改为1已领取
                    $http({
                        url:'/orders/deliver',
                        method:'POST',
                        data:{
                            id:id
                        }
                    }).success(function(undeliver_orders){
                        //发货成功之后，1更新未发货数据，2插入发货订单记录
                        alert('领取订单成功');
                        $scope.undeliver_orders =undeliver_orders;
//                        $scope.has_new_deliver_order_record = true;
                    }).error(function(){
                        alert('发货失败');
                    });
                }
            }).error(function(){
                alert('生成发货订单记录失败');
            });

        };

        //领取周期配送配送
        $scope.deliver_cycle_distribution =function(id,index){
            $scope.cycle_distribution_record =$scope.today_undeliver_cycle_distributions[index];
            $scope.cycle_distribution_record.last_distribution_date =today;
            $scope.cycle_distribution_record.worker_id =$rootScope.activeWorker._id;
            $scope.cycle_distribution_record.state =4;//0:表示未回收,1表示配送,2表示取消,3表示日期过了失效,4已完成
            $scope.cycle_distribution_record.is_get_pay =1;//是否付款:0用户未付款，1用户已付款。
            //插入周期配送记录
            $http({
                url:'/cycle_distribution_records/add',
                method:"POST",
                data:$scope.cycle_distribution_record
            }).success(function (cycle_distribution_record) {
                if(cycle_distribution_record){
                    $scope.has_new_deliver_cycle_distribution_record =true;
                    //清空
                    $scope.today_undeliver_cycle_distributions =[];
                    //将对应的周期配送的状态改为1已领取
                    $http({
                        url:'/cycle_distributions/deliver',
                        method:'POST',
                        data:{
                            id:id,
                            last_distribution_date:today
                        }
                    }).success(function(all_undeliver_cycle_distributions){
                        //领取成功之后，1更新未配送数据，2插入配送周期配送记录
                        $scope.all_undeliver_cycle_distributions = all_undeliver_cycle_distributions;

                        //根据间隔计算今日需要上门的周期配送
                        angular.forEach($scope.all_undeliver_cycle_distributions,function(undeliver_cycle_distribution,key){
                            var is_today =$scope.getNextDate(undeliver_cycle_distribution.last_distribution_date,undeliver_cycle_distribution.interval);
                            if(is_today ==today){
                                $scope.today_undeliver_cycle_distributions.push(undeliver_cycle_distribution);
                            }
                        });
                        alert('领取成功');
                    }).error(function(){
                        alert('配送失败');
                    });
                }
            }).error(function(){
                alert('生成配送记录失败');
            });

        };

        //获取所有已领取未付款的预约记录
        $scope.show_claim_unpay_bespeak_recycle_records =function(worker_job_number){
            $scope.is_show_unclaim_bespeak_recycles_table =false;
            $scope.is_show_claim_unpay_bespeak_recycle_records_table =true;
            $scope.is_show_claim_pay_bespeak_recycle_records_table =false;
            if($scope.claim_unpay_bespeak_recycle_records ==undefined){
                //获取今天所有未处理的预约回收
                $http({
                    url:'/bespeak_recycle_records/find_by_job_number',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_unpay_bespeak_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_unpay_bespeak_recycle_records =claim_unpay_bespeak_recycle_records;
                });
            }
            if($scope.has_new_claim_unpay_bespeak_recycle_record){
                //获取今天所有未处理的预约回收
                $http({
                    url:'/bespeak_recycle_records/find_by_job_number',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_unpay_bespeak_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_unpay_bespeak_recycle_records =claim_unpay_bespeak_recycle_records;
                    $scope.has_new_claim_unpay_bespeak_recycle_record =false;
                });
            }
        };

        //获取所有已领取未付款的周期回收记录
        $scope.show_claim_unpay_cycle_recycle_records =function(worker_job_number){
            $scope.is_show_today_unclaim_cycle_recycles_table =false;
            $scope.is_show_all_unclaim_cycle_recycles_table =false;
            $scope.is_show_claim_unpay_cycle_recycle_records_table =true;
            $scope.is_show_claim_pay_cycle_recycle_records_table =false;
            if($scope.claim_unpay_cycle_recycle_records ==undefined){
                //获取所有未付款的周期回收记录
                $http({
                    url:'/cycle_recycle_records/find_by_job_number_unpay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_unpay_cycle_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_unpay_cycle_recycle_records =claim_unpay_cycle_recycle_records;
                });
            }
            if($scope.has_new_claim_unpay_cycle_recycle_record){
                //获取所有未付款的周期回收记录
                $http({
                    url:'/cycle_recycle_records/find_by_job_number_unpay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_unpay_cycle_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_unpay_cycle_recycle_records =claim_unpay_cycle_recycle_records;
                });
            }
        };

        //预约回收付款
        $scope.pay_claim_bespeak_recycle_record =function(id){
            $http({
                url:'/bespeak_recycle_records/find_by_id',
                method:"POST",
                data:{
                    id:id
                }
            }).success(function (bespeak_recycle_record) {
                $scope.will_pay_bespeak_recycle_record =bespeak_recycle_record;
                $('#pay_bespeak_recycle_record_modal').modal('show');
            }).error(function(){
                alert('获取领取记录失败');
            });
        };

        //周期回收付款
        $scope.pay_claim_cycle_recycle_record =function(id){
            $http({
                url:'/cycle_recycle_records/find_by_id',
                method:"POST",
                data:{
                    id:id
                }
            }).success(function (cycle_recycle_record) {
                $scope.will_pay_cycle_recycle_record =cycle_recycle_record;
                $('#pay_cycle_recycle_record_modal').modal('show');
            }).error(function(){
                alert('获取领取记录失败');
            });
        };

        //确认预约回收付款
        $scope.confirm_pay_claim_bespeak_recycle =function(){
            $scope.will_pay_bespeak_recycle_record.state =4;//已完成
            $scope.will_pay_bespeak_recycle_record.is_pay =1;//已付款
            $http({
                url:'/bespeak_recycle_records/confirm_pay',
                method:"POST",
                data:$scope.will_pay_bespeak_recycle_record
            }).success(function (bespeak_recycle_records) {
                if($scope.will_pay_bespeak_recycle_record.pay_mode ==0){
                    $http({
                        url:'/users/get_pay',
                        method:"POST",
                        data:{
                            user_id:$scope.will_pay_bespeak_recycle_record.user_id,
                            pay_number:$scope.will_pay_bespeak_recycle_record.pay_number
                        }
                    }).success(function (user) {
                        if(user){
                            $('#pay_bespeak_recycle_record_modal').modal('hide');
                            alert('付款成功');
                            $scope.claim_unpay_bespeak_recycle_records =bespeak_recycle_records;
                            $scope.has_new_claim_pay_bespeak_recycle_record =true;
                        }
                    });
                }else{
                    $('#pay_bespeak_recycle_record_modal').modal('hide');
                    alert('付款成功');
                    $scope.claim_unpay_bespeak_recycle_records =bespeak_recycle_records;
                    $scope.has_new_claim_pay_bespeak_recycle_record =true;
                }

            }).error(function(){
                alert('付款失败');
            });
        };

        //确认周期回收记录付款
        $scope.confirm_pay_claim_cycle_recycle_record =function(){
            $scope.will_pay_cycle_recycle_record.state =4;//已完成
            $scope.will_pay_cycle_recycle_record.is_pay =1;//已付款
            $http({
                url:'/cycle_recycle_records/confirm_pay',
                method:"POST",
                data:$scope.will_pay_cycle_recycle_record
            }).success(function (cycle_recycle_records) {
                if($scope.will_pay_cycle_recycle_record.pay_mode ==0){
                    $http({
                        url:'/users/get_pay',
                        method:"POST",
                        data:{
                            user_id:$scope.will_pay_cycle_recycle_record.user_id,
                            pay_number:$scope.will_pay_cycle_recycle_record.pay_number
                        }
                    }).success(function (user) {
                        if(user){
                            $('#pay_cycle_recycle_record_modal').modal('hide');
                            alert('付款成功');
                            $scope.claim_unpay_cycle_recycle_records =cycle_recycle_records;
                            $scope.has_new_claim_pay_cycle_recycle_record =true;
                        }
                    });
                }else{
                    $('#pay_cycle_recycle_record_modal').modal('hide');
                    alert('付款成功');
                    $scope.claim_unpay_cycle_recycle_records =cycle_recycle_records;
                    $scope.has_new_claim_pay_cycle_recycle_record =true;
                }

            }).error(function(){
                alert('付款失败');
            });
        };

        //显示所有已完成的预约回收记录
        $scope.show_claim_pay_bespeak_recycle_records =function(worker_job_number){
            $scope.is_show_unclaim_bespeak_recycles_table =false;
            $scope.is_show_claim_unpay_bespeak_recycle_records_table =false;
            $scope.is_show_claim_pay_bespeak_recycle_records_table =true;
            if($scope.claim_pay_bespeak_recycle_records ==undefined){
                //获取所有已完成的预约回收记录
                $http({
                    url:'/bespeak_recycle_records/find_claim_pay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_pay_bespeak_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_pay_bespeak_recycle_records =claim_pay_bespeak_recycle_records;
                });
            }
            if($scope.has_new_claim_pay_bespeak_recycle_record){
                //获取所有已完成的预约回收记录
                $http({
                    url:'/bespeak_recycle_records/find_claim_pay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_pay_bespeak_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_pay_bespeak_recycle_records =claim_pay_bespeak_recycle_records;
                    $scope.has_new_claim_pay_bespeak_recycle_record =false;
                });
            }
        };

        //显示所有已完成的周期回收记录
        $scope.show_claim_pay_cycle_recycle_records =function(worker_job_number){
            $scope.is_show_today_unclaim_cycle_recycles_table =false;
            $scope.is_show_all_unclaim_cycle_recycles_table =false;
            $scope.is_show_claim_unpay_cycle_recycle_records_table =false;
            $scope.is_show_claim_pay_cycle_recycle_records_table =true;
            if($scope.claim_pay_cycle_recycle_records ==undefined){
                //获取所有已完成的周期回收记录
                $http({
                    url:'/cycle_recycle_records/find_claim_pay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_pay_cycle_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_pay_cycle_recycle_records =claim_pay_cycle_recycle_records;
                });
            }
            if($scope.has_new_claim_pay_cycle_recycle_record){
                //获取所有已完成的周期回收记录
                $http({
                    url:'/cycle_recycle_records/find_claim_pay',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(claim_pay_cycle_recycle_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.claim_pay_cycle_recycle_records =claim_pay_cycle_recycle_records;
                    $scope.has_new_claim_pay_cycle_recycle_record =false;
                });
            }
        };

        //显示所有已完成的订单发货记录
        $scope.show_deliver_order_records =function(worker_job_number){
            $scope.is_show_undeliver_orders_table =false;
            $scope.is_show_deliver_order_records_table =true;
            if($scope.deliver_order_records ==undefined){
                //获取所有已完成的订单发货记录
                $http({
                    url:'/order_records/find_deliver',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(deliver_order_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.deliver_order_records =deliver_order_records;
                });
            }
            if($scope.has_new_deliver_order_record){
                //获取所有已完成的订单发货记录
                $http({
                    url:'/order_records/find_deliver',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(deliver_order_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.deliver_order_records =deliver_order_records;
                    $scope.has_new_deliver_order_record =false;
                });
            }
        };

        //显示所有已完成的周期配送记录
        $scope.show_deliver_cycle_distribution_records =function(worker_job_number){
            $scope.is_show_today_undeliver_cycle_distributions_table =false;
            $scope.is_show_all_undeliver_cycle_distributions_table =false;
            $scope.is_show_deliver_cycle_distribution_records_table =true;
            if($scope.deliver_cycle_distribution_records ==undefined){
                //获取所有已完成的订单发货记录
                $http({
                    url:'/cycle_distribution_records/find_deliver',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(deliver_cycle_distribution_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.deliver_cycle_distribution_records =deliver_cycle_distribution_records;
                });
            }
            if($scope.has_new_deliver_cycle_distribution_record){
                //获取所有已完成的订单发货记录
                $http({
                    url:'/cycle_distribution_records/find_deliver',
                    method:'POST',
                    data:{
                        job_number:worker_job_number
                    }
                }).success(function(deliver_cycle_distribution_records){
//                    console.log(JSON.stringify(claim_unpay_bespeak_recycles));
                    $scope.deliver_cycle_distribution_records =deliver_cycle_distribution_records;
                    $scope.has_new_deliver_cycle_distribution_record =false;

                });
            }
        };

        //日期加上天数得到新的日期
        $scope.getNextDate =function(dateTemp, days) {
            var beginDate = dateTemp.split("-");
            var millSeconds =  (new Date(beginDate[0] + '/' + beginDate[1] + '/' + beginDate[2])).getTime() + (days * 24 * 60 * 60 * 1000);
            var rDate = new Date(millSeconds);
            var year = rDate.getFullYear();
            var month = rDate.getMonth() + 1;
//            if (month < 10) month = "0" + month;
            var date = rDate.getDate();
//            if (date < 10) date = "0" + date;
            return (year + "-" + month + "-" + date);
        };
    });
    //根据不同的时间显示不同的间隔
    app.filter('translate_number_interval', function() {
        return function(number) {
            if(number ==7){
                return '一周';
            }else if(number ==14){
                return '两周';
            }else if(number ==21){
                return '三周';
            }else if(number ==30){
                return '四周';
            }else if(number ==60){
                return '两个月';
            }else if(number ==75){
                return '两个半月';
            }else if(number ==90){
                return '三个月';
            }
        }
    });
    //页面刷新时检测是否登录
    app.run(function($rootScope,$http,$window){
        $http({
            url:'/workers/is_login',
            method:"POST",
        }).success(function (worker) {
            $rootScope.activeWorker =worker;
        }).error(function(data){
            alert('no login,'+data.msg);
            $window.location.href="login.html";
        });
    });
</script>
</html>